/*
 * (salloc.c | 18 Nov 18 | Ahmad Maher)
 *
 * See strutil.h for full descreiption.
 *
*/

#include <string.h>

#include "salloc.h"
#include "alloc.h"

static string *buckets[SHASH_SIZE];

/* randoms numbers generated by getrandom syscall
   for strings hashing */
static unsigned somes[] = {    
    81790281,   1337979116, 2191314030, 3319093084, 3505191228, 
    1261606494, 1409675166, 2018843663, 557228805,  2890055434, 
    3436858821, 2663168627, 1187759934, 1737952476, 3885819590, 
    1650426744, 840592143,  2757211283, 2415766105, 3786597703, 
    3922384213, 2877936947, 1027393222, 2371332812, 1044934772, 
    1994055916, 82798147,   3866849388, 1163489686, 63598504, 
    1714395852, 2127138041, 1595245019, 3466796082, 381797855, 
    741519258,  2021135234, 1692029097, 4133820969, 3566245831, 
    2922138365, 9057624,    3077813476, 2443569280, 3030653780, 
    2113516406, 501071294,  1429286470, 356498097,  4031942820, 
    2915492210, 3633434285, 1302801224, 1821380895, 954923555, 
    1022620517, 1302679381, 3947395190, 2764433961, 2461599685, 
    3022677840, 2814561267, 2609015872, 3232617121, 188010681, 
    4049061828, 2948900784, 1693238746, 954797123,  706796681, 
    903714235,  3780261580, 3282662822, 1884263221, 4196060024, 
    2336051514, 607085224,  4200496100, 2681825279, 2420684145, 
    3606905247, 987089768,  2848469227, 400212905,  1529820569, 
    607087174,  2177730199, 3715177751, 824153550,  1140401305, 
    2616510505, 511886786,  2873320080, 3118150664, 325329663, 
    935121301,  1451003427, 4251399005, 3848362642, 890407091, 
    1073228044, 2359098307, 3040158836, 1258649966, 3179584679, 
    3006868142, 3658509572, 284378159,  3832145117, 1378836144, 
    845211147,  2212808798, 673053187,  829508459,  3815892590, 
    1955745167, 1418696675, 1113326897, 1239188181, 2263655964, 
    755022748,  514779883,  1228620223, 923189460,  2541054247, 
    1032901151, 653567097,  2807831490, 3277799786, 2037998379, 
    1312974954, 4156397619, 327695123,  3482213368, 3350476065, 
    3677103814, 1634801901, 3559129589, 1026908788, 342096411, 
    142679033,  2714815501, 3124080498, 3535963953, 3051199351, 
    3641050077, 2043507738, 2206040135, 2727907431, 3085024689, 
    3840778375, 2510269048, 4039368748, 3150678141, 1113927268, 
    2880001343, 3125195683, 2497890256, 254887606,  3174915881, 
    3284020696, 1966826799, 939838070,  2549150203, 110347885, 
    2545815040, 3579245832, 1985578928, 1416673894, 3111585050, 
    4032790201, 2210789119, 566395581,  2571421651, 81928129, 
    2668660688, 1660153375, 2562551427, 75591518,   3793406990, 
    491662345,  1449470937, 1616997410, 1090631369, 2109044063, 
    1206308713, 2142842510, 3915953326, 3175424389, 3515351029, 
    2002334013, 2128522139, 1295744329, 2694590152, 2835277022, 
    323360029,  1918669346, 2040893013, 2833567311, 3265143556, 
    230816252,  725304511,  3187675430, 1073094185, 256427179, 
    103602016,  1458035820, 2199967094, 3128440290, 1725250165, 
    2456473837, 2602491395, 944924566,  3900448223, 2518264956, 
    2168695463, 1008638681, 2905191221, 2759764393, 309815910, 
    1019725764, 1315346345, 3385155701, 141361097,  3400148716, 
    1753401623, 3468692929, 4141755136, 1501650311, 1356813367, 
    3817338503, 2244914052, 1738402273, 1550694923, 2438852161, 
    2309784547, 2294729070, 1662421684, 3844623417, 4247636504, 
    313689747,  1227678324, 1082710277, 2658820308, 1292022839, 
    3178401955, 2821776186, 1663065257, 3323805245, 2372388703, 
    2961601607, 3170159391, 2007293606, 878641875,  1375112946, 
    478961349
};

char *strn(const char *s, unsigned long len) {
    unsigned shash;
    const char *end;
    string *p;
    int i = len;

    /* generate unforimly distributed hash for string s */
    for (i = len, end = s, shash = 0; i > 0; i--)
        shash = (shash<<1) + somes[*(unsigned char *)end++];
    shash &= SHASH_SIZE - 1;

    /* looking for the string s in the string table */
    for (p = buckets[shash]; p; p = p->link) {
        /* could use strcmp without comparing the length
           but strcmp is expensive function so, the 
           comparison happen only for the same length */
        if (len == p->len && !strcmp(s, p->s))
            return p->s;
    }

    /* install new string in the string table */
    /* strn stores new strings in permanently allocated 
       memory of at least 4*1024 Bytes at PERM region */
    static char
        *next,    /* the next free position in the current chuck */
        *slimit;  /* points to one past the end of the chunk */
        
    if (next + len + 1 >= slimit) {
        int n = len + 4*1024;
        next = alloc(n, R_PERM);
        slimit = next + n;
    }
        
    p = make(p, R_PERM);
    p->len = len;
    /* here this loop is probably faster than strcpy */
    for (p->s = next; s < end;)
        *next++ = *s++;
    *next++ = '\0';
    p->link = buckets[shash];
    buckets[shash] = p;
    return p->s;
}

char *str(const char *s) {
    return strn(s, strlen(s));
}
